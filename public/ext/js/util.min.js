'use strict';var fs=require('fs');var path=require('path');var util=require('util');var glob=require('glob');var he=require('he');var errors=require('./errors');var createNoFilesMatchPatternError=errors.createNoFilesMatchPatternError;var createMissingArgumentError=errors.createMissingArgumentError;var assign=(exports.assign=require('object.assign').getPolyfill());exports.inherits=util.inherits;exports.escape=function(html){return he.encode(String(html),{useNamedReferences:!1})};exports.isString=function(obj){return typeof obj==='string'};exports.watch=function(files,fn){var options={interval:100};var debug=require('debug')('mocha:watch');files.forEach(function(file){debug('file %s',file);fs.watchFile(file,options,function(curr,prev){if(prev.mtime<curr.mtime){fn(file)}})})};function considerFurther(pathname){var ignore=['node_modules','.git'];return!~ignore.indexOf(pathname)}
exports.files=function(dir,exts,ret){ret=ret||[];exts=exts||['js'];fs.readdirSync(dir).filter(considerFurther).forEach(function(dirent){var pathname=path.join(dir,dirent);if(fs.lstatSync(pathname).isDirectory()){exports.files(pathname,exts,ret)}else if(hasMatchingExtname(pathname,exts)){ret.push(pathname)}});return ret};exports.slug=function(str){return str.toLowerCase().replace(/ +/g,'-').replace(/[^-\w]/g,'')};exports.clean=function(str){str=str.replace(/\r\n?|[\n\u2028\u2029]/g,'\n').replace(/^\uFEFF/,'').replace(/^function(?:\s*|\s+[^(]*)\([^)]*\)\s*\{((?:.|\n)*?)\s*\}$|^\([^)]*\)\s*=>\s*(?:\{((?:.|\n)*?)\s*\}|((?:.|\n)*))$/,'$1$2$3');var spaces=str.match(/^\n?( *)/)[1].length;var tabs=str.match(/^\n?(\t*)/)[1].length;var re=new RegExp('^\n?'+(tabs?'\t':' ')+'{'+(tabs||spaces)+'}','gm');str=str.replace(re,'');return str.trim()};exports.parseQuery=function(qs){return qs.replace('?','').split('&').reduce(function(obj,pair){var i=pair.indexOf('=');var key=pair.slice(0,i);var val=pair.slice(++i);obj[key]=decodeURIComponent(val.replace(/\+/g,'%20'));return obj},{})};function highlight(js){return js.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\/\/(.*)/gm,'<span class="comment">//$1</span>').replace(/('.*?')/gm,'<span class="string">$1</span>').replace(/(\d+\.\d+)/gm,'<span class="number">$1</span>').replace(/(\d+)/gm,'<span class="number">$1</span>').replace(/\bnew[ \t]+(\w+)/gm,'<span class="keyword">new</span> <span class="init">$1</span>').replace(/\b(function|new|throw|return|var|if|else)\b/gm,'<span class="keyword">$1</span>')}
exports.highlightTags=function(name){var code=document.getElementById('mocha').getElementsByTagName(name);for(var i=0,len=code.length;i<len;++i){code[i].innerHTML=highlight(code[i].innerHTML)}};function emptyRepresentation(value,typeHint){switch(typeHint){case 'function':return'[Function]';case 'object':return'{}';case 'array':return'[]';default:return value.toString()}}
var type=(exports.type=function type(value){if(value===undefined){return'undefined'}else if(value===null){return'null'}else if(Buffer.isBuffer(value)){return'buffer'}
return Object.prototype.toString.call(value).replace(/^\[.+\s(.+?)]$/,'$1').toLowerCase()});exports.stringify=function(value){var typeHint=type(value);if(!~['object','array','function'].indexOf(typeHint)){if(typeHint==='buffer'){var json=Buffer.prototype.toJSON.call(value);return jsonStringify(json.data&&json.type?json.data:json,2).replace(/,(\n|$)/g,'$1')}
if(typeHint==='string'&&typeof value==='object'){value=value.split('').reduce(function(acc,char,idx){acc[idx]=char;return acc},{});typeHint='object'}else{return jsonStringify(value)}}
for(var prop in value){if(Object.prototype.hasOwnProperty.call(value,prop)){return jsonStringify(exports.canonicalize(value,null,typeHint),2).replace(/,(\n|$)/g,'$1')}}
return emptyRepresentation(value,typeHint)};function jsonStringify(object,spaces,depth){if(typeof spaces==='undefined'){return _stringify(object)}
depth=depth||1;var space=spaces*depth;var str=Array.isArray(object)?'[':'{';var end=Array.isArray(object)?']':'}';var length=typeof object.length==='number'?object.length:Object.keys(object).length;function repeat(s,n){return new Array(n).join(s)}
function _stringify(val){switch(type(val)){case 'null':case 'undefined':val='['+val+']';break;case 'array':case 'object':val=jsonStringify(val,spaces,depth+1);break;case 'boolean':case 'regexp':case 'symbol':case 'number':val=val===0&&1/val===-Infinity?'-0':val.toString();break;case 'date':var sDate=isNaN(val.getTime())?val.toString():val.toISOString();val='[Date: '+sDate+']';break;case 'buffer':var json=val.toJSON();json=json.data&&json.type?json.data:json;val='[Buffer: '+jsonStringify(json,2,depth+1)+']';break;default:val=val==='[Function]'||val==='[Circular]'?val:JSON.stringify(val)}
return val}
for(var i in object){if(!Object.prototype.hasOwnProperty.call(object,i)){continue}
--length;str+='\n '+repeat(' ',space)+(Array.isArray(object)?'':'"'+i+'": ')+_stringify(object[i])+(length?',':'')}
return(str+(str.length!==1?'\n'+repeat(' ',--space)+end:end))}
exports.canonicalize=function canonicalize(value,stack,typeHint){var canonicalizedObj;var prop;typeHint=typeHint||type(value);function withStack(value,fn){stack.push(value);fn();stack.pop()}
stack=stack||[];if(stack.indexOf(value)!==-1){return'[Circular]'}
switch(typeHint){case 'undefined':case 'buffer':case 'null':canonicalizedObj=value;break;case 'array':withStack(value,function(){canonicalizedObj=value.map(function(item){return exports.canonicalize(item,stack)})});break;case 'function':for(prop in value){canonicalizedObj={};break}
if(!canonicalizedObj){canonicalizedObj=emptyRepresentation(value,typeHint);break}
case 'object':canonicalizedObj=canonicalizedObj||{};withStack(value,function(){Object.keys(value).sort().forEach(function(key){canonicalizedObj[key]=exports.canonicalize(value[key],stack)})});break;case 'date':case 'number':case 'regexp':case 'boolean':case 'symbol':canonicalizedObj=value;break;default:canonicalizedObj=value+''}
return canonicalizedObj};function hasMatchingExtname(pathname,exts){var suffix=path.extname(pathname).slice(1);return exts.some(function(element){return suffix===element})}
function isHiddenOnUnix(pathname){return path.basename(pathname)[0]==='.'}
exports.lookupFiles=function lookupFiles(filepath,extensions,recursive){extensions=extensions||[];recursive=recursive||!1;var files=[];var stat;if(!fs.existsSync(filepath)){var pattern;if(glob.hasMagic(filepath)){pattern=filepath}else{var strExtensions=extensions.map(function(v){return'.'+v}).join('|');pattern=filepath+'+('+strExtensions+')'}
files=glob.sync(pattern,{nodir:!0});if(!files.length){throw createNoFilesMatchPatternError('Cannot find any files matching pattern '+exports.dQuote(filepath),filepath)}
return files}
try{stat=fs.statSync(filepath);if(stat.isFile()){return filepath}}catch(err){return}
fs.readdirSync(filepath).forEach(function(dirent){var pathname=path.join(filepath,dirent);var stat;try{stat=fs.statSync(pathname);if(stat.isDirectory()){if(recursive){files=files.concat(lookupFiles(pathname,extensions,recursive))}
return}}catch(err){return}
if(!extensions.length){throw createMissingArgumentError(util.format('Argument %s required when argument %s is a directory',exports.sQuote('extensions'),exports.sQuote('filepath')),'extensions','array')}
if(!stat.isFile()||!hasMatchingExtname(pathname,extensions)||isHiddenOnUnix(pathname)){return}
files.push(pathname)});return files};function emitWarning(msg,type){if(process.emitWarning){process.emitWarning(msg,type)}else{process.nextTick(function(){console.warn(type+': '+msg)})}}
exports.deprecate=function deprecate(msg){msg=String(msg);if(msg&&!deprecate.cache[msg]){deprecate.cache[msg]=!0;emitWarning(msg,'DeprecationWarning')}};exports.deprecate.cache={};exports.warn=function warn(msg){if(msg){emitWarning(msg)}};exports.stackTraceFilter=function(){var is=typeof document==='undefined'?{node:!0}:{browser:!0};var slash=path.sep;var cwd;if(is.node){cwd=process.cwd()+slash}else{cwd=(typeof location==='undefined'?window.location:location).href.replace(/\/[^/]*$/,'/');slash='/'}
function isMochaInternal(line){return(~line.indexOf('node_modules'+slash+'mocha'+slash)||~line.indexOf(slash+'mocha.js')||~line.indexOf(slash+'mocha.min.js'))}
function isNodeInternal(line){return(~line.indexOf('(timers.js:')||~line.indexOf('(events.js:')||~line.indexOf('(node.js:')||~line.indexOf('(module.js:')||~line.indexOf('GeneratorFunctionPrototype.next (native)')||!1)}
return function(stack){stack=stack.split('\n');stack=stack.reduce(function(list,line){if(isMochaInternal(line)){return list}
if(is.node&&isNodeInternal(line)){return list}
if(/:\d+:\d+\)?$/.test(line)){line=line.replace('('+cwd,'(')}
list.push(line);return list},[]);return stack.join('\n')}};exports.isPromise=function isPromise(value){return(typeof value==='object'&&value!==null&&typeof value.then==='function')};exports.clamp=function clamp(value,range){return Math.min(Math.max(value,range[0]),range[1])};exports.sQuote=function(str){return"'"+str+"'"};exports.dQuote=function(str){return'"'+str+'"'};exports.ngettext=function(n,msg1,msg2){if(typeof n==='number'&&n>=0){return n===1?msg1:msg2}};exports.noop=function(){};exports.createMap=function(obj){return assign.apply(null,[Object.create(null)].concat(Array.prototype.slice.call(arguments)))};exports.defineConstants=function(obj){if(type(obj)!=='object'||!Object.keys(obj).length){throw new TypeError('Invalid argument; expected a non-empty object')}
return Object.freeze(exports.createMap(obj))}